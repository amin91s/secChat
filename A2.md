**Key distribution:**

The server and ttp certificates and keys are created via the makefile on
the make all command. First it generates an RSA key for the CA, and then
signs its X5.09 using the private key. It then generates RSA key and a
Certificate signing request for the server, and signs it using the CA's
key.

It also copies the CA's certificate in the clientkeys directory which
allows clients to verify server's identity while establishing the SSL
connection.

Generating key and certificate for the users is done by running the TTP
script whenever a new user is registered. The certificates are signed by
ttp and can be verified by other clients.

Additionally, users can generate symmetric keys themselves.

The generated RSA keys are 2048 bit, while AES keys are generated using
256 bits CBC mode with 32 bytes key and a 16 bytes iv.

Overview of message types exchanged:

**struct api_msg:** This is the main structure that holds a message. The
key field within this struct is enum cmd_type type, which describes
which of the 6 different message types the structure is representing.
Besides the type field, api_msg also holds a union of different structs
that are associated with each message type.

**cmd_type:** this enum (located in **cmd.h** file) holds the
different message types that clients/server can send.

**CMD_LOGIN, CMD_REGISTER:**

These two types are used for registration/login messages. The structure
associated with this message type holds client's username and password.

**CMD_PRIVATE_MSG:** type of private messages.

The associated struct includes the sender and receiver's usernames,
encrypted message, encrypted message length, message signature, message
signature length

**CMD_PUBLIC_MSG:** type of public messages

The associated struct includes the sender usernames, message, message
signature, message signature length

**CMD_USERS:** message type used for asking server for the list of
currently logged in users

**CMD_KEY_EXC:** message type used for exchanging symmetric keys between
users

**Cryptography:**

Clients establish an SSL connection to the server and use CA's
certificate to validate the server. SSL provides confidentiality and
integrity of the connection to the server.

No crypto is applied for the login/register commands, as it is already
provided by the SSL connection. It is possible to require signature for
the login commands as well, which prevents the attacker from logging in
as other users if she has only obtained the password but not the private
key.

When registering new users, the password is hashed on the server side
using slow hash (sha256). The hash and salt are stored in the database.
This prevents attacker from obtaining passwords if the server is
compromised.

Both public and private messages are signed by the sender using the
private key. Server verifies the signature before storing the message in
the database. Clients verify the signature as well. This provides
integrity and non-repudiation even server is compromised.

Additionally, private messages are encrypted using AES symmetric key
which prevents server from reading private messages.

To exchange symmetric keys (CMD_KEY_EXC message type), client first
generates an AES key (stored in the clientkeys folder) and encrypts it
using the receiver's public key. Then it signs the message using its own
private key. Receiver first verifies the signature and decrypts the
message using the private key. Then it stores the AES key in its
clientkeys directory. This type of message is not stored in the
database.
